        {% extends "base.html"  %}
        {% block title %}
            <h1> Firetower - Total Errors per Category </h1>
        {% endblock %}
        {% block content %}
        <div id="aggregate">
            <div id="aggregatePlaceholder">
                <div id="loadingMsg">Loading...</div>
            </div>
            <div id="legend"></div>
            <div id="key"></div>
        </div>

        <script type="text/javascript">
            var timeseriesData = new Array();
            // Hashmap holding the currently graphed timeseries
            var graphedData = new Array();

            var addSeries = function(){
                toggleSeries($(this), true);
                return false;
            }

            var killSeries = function(){
                toggleSeries($(this), false);
                return false;
            }

            var toggleSeries = function(link, add){
                var link_id = link.attr("id");
                var cat_id = link_id.replace("_link", "")
                graphedData[cat_id] = add ? timeseriesData[cat_id] : new Array();
                loadGraphData();

                for (cat_id in graphedData){
                    var link_id = "#" + cat_id + "_link";
                    var new_link = $(link_id);
                    var visible = graphedData[cat_id].length > 0;
                    new_link.html(visible ? "-" : "+");
                    if (!visible){
                        new_link.attr("class", "addSeries")
                    }
                }

                $('.addSeries').unbind('click')
                $('.killSeries').unbind('click')
                $('.addSeries').bind('click', addSeries)
                $('.killSeries').bind('click', killSeries)
                $("#tooltip").remove();
                return false;
            }

            var buildLabel = function(label, series) {
                var killSeries = "<a id='" + label + "_link' class='killSeries' href='#'>-</a>"
                return label + "&nbsp;" + killSeries;
            }

            var loadGraphData = function(){
                // Empty array to hold chart data
                var chartData = new Array();
                for (cat in graphedData) {
                    // Store category name & data for chart
                    chartData.push(
                        { label: cat, data: graphedData[cat] }
                    )
                }

                drawAggChart(chartData);
            }

            $(function () {

            getAggregateData = function() {
                $("#loadingMsg").show();
                var handler = $.ajax({
                    url: "/api/categories/timeseries",
                    success: function(returnedData, httpStatus, xhr){
                        timeseriesData = JSON.parse(returnedData);
                        for (cat in timeseriesData) {
                            graphedData[cat] = timeseriesData[cat];

                            // Sum total instances per category
                            var catTotal = 0;
                            for (var i=0, arr; arr=timeseriesData[cat][i]; i++) {
                                catTotal += arr[1];
                            }

                            // Get human-readable category name
                            getCategoryName(cat, catTotal);
                        }
                        loadGraphData();
                        $('.addSeries').bind('click', addSeries)
                        $('.killSeries').bind('click', killSeries)
                    }
                });
            }

            drawAggChart = function(chartData) {
                $("#loadingMsg").hide();
                $.plot(
                    $("#aggregatePlaceholder"),
                    chartData,
                    {
                        series: {
                            lines: { show: true },
                            points: { show: true }
                        },
                        xaxis: { mode: "time" },
                        yaxis: { min: 1 },
                        grid: { hoverable: true, clickable: true },
<<<<<<< HEAD
                        legend: {
                            labelFormatter: buildLabel,
                            container: "#legend",
                            noColumns: 3
                        }
=======
                        legend: { container: "#legend", noColumns: 3 }
>>>>>>> Moving the legend to below the graph so it doesn't block off data
                    }
                );
            }

            getCategoryName = function(catId, catTotal) {
                var handler = $.ajax({
                    url: "/api/categories/",
                    success: function(jsonData, httpStatus, xhr){
                        var catData = JSON.parse(jsonData);
                        var catName = catData[catId].human_name;
                        writeAggKey(catId, catName, catTotal);
                    }
                });
            }

            // Write key for aggregate chart
            writeAggKey = function(catId, catName, catTotal) {

                // Add category name & totals to key
                $("#key").append(
                    '<div class="keyEntry" id="'+catId+'"></div>')

                $("#"+catId).append('<div class="catTotal"><h1>'+catTotal+'</h1></div><div class="catName"><a href="/category/'+catId+'">'+catName+'</a></div>')
            }

            // Get default timeseries data for all categories
            // & draw chart
            getAggregateData();

            function showTooltip(x, y, contents) {
                $('<div id="tooltip">' + contents + '</div>').css( {
                    position: 'absolute',
                    display: 'none',
                    top: y + 5,
                    left: x + 5,
                    border: '1px solid #fdd',
                    padding: '2px',
                    'background-color': '#fee',
                    opacity: 0.80
                }).appendTo("body").fadeIn(200);
            }

            var previousPoint = null;
            $("#aggregatePlaceholder").bind("plothover", function (event, pos, item) {
                $("#x").text(pos.x.toFixed(2));
                $("#y").text(pos.y.toFixed(2));

                if (item) {
                    if (previousPoint != item.dataIndex) {
                        previousPoint = item.dataIndex;

                        $("#tooltip").remove();
                        var x = item.datapoint[0].toFixed(2),
                            y = item.datapoint[1].toFixed(2);

                        var catData = "";
                        $.ajax({
                            async: false,
                            url: "/api/categories/",
                            success: function(jsonData, httpStatus, xhr){
                                catData = JSON.parse(jsonData);
                            }
                        });

                        var date = new Date(Math.floor(x));
                        var date_str = date.getFullYear() + "/" + date.getMonth() + "/" + date.getDay();
                        var time_str = date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
                        for(var cat in catData){
                            if (item.series.label == cat){
                                cat_name = catData[cat]["human_name"];
                            }
                        }
                        var tooltip_msg = "At " + date_str + " " + time_str + " " + " category " + cat_name  + " got " + y + " hits"

                        showTooltip(
                            item.pageX, item.pageY,
                            tooltip_msg
                        );
                    }
                }
                else {
                    $("#tooltip").remove();
                    previousPoint = null;
                }
            });

            });
        </script>
        {% endblock %}
