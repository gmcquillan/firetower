        {% extends "base.html"  %}
        {% block title %}
            <h1> Firetower - Total Errors per Category </h1>
        {% endblock %}
        {% block content %}
        <div id="aggregate">
            <div id="aggregatePlaceholder">
                <div id="loadingMsg">Loading...</div>
            </div>
            <div id="legend"></div>
            <div id="key"></div>
            Filter out categories with fewer than <input type="text" id="filter_threshold" value="5" /> hits.
            <div id="reload">
            Auto reload: <input type="checkbox" id="reload_check" /><br />
            <div id="set_reload">Reload every <input type="text" id="reload_input" value="60"/> seconds</div>
            Last updated <span id="last_reload">-</span> seconds ago.<br />
            <select name="slice" id="slice_selection">
                {% for element in time_slice_options %}
                <option value="{{ element }}">{{ element }}</option>
                {% endfor %}
            </select>
            </div>
        </div>

        <script type="text/javascript">
            var timeSinceReload = 0;
            var reloadEvery = 0;
            var catData = new Array();
            var filterThreshold = 0;
            var catCounts = new Array();
            {% if time_slice %}
            var timeSlice = '{{ time_slice }}';
            {% else %}
            var timeSlice = "minute";
            {% endif %}

            $("#slice_selection").val(timeSlice);

            var timeseriesData = new Array();
            // Hashmap holding the currently graphed timeseries
            var graphedData = new Array();

            var addSeries = function(){
                toggleSeries($(this), true);
                return false;
            }

            var killSeries = function(){
                toggleSeries($(this), false);
                return false;
            }

            var getCategoryMetadata = function(){
                $.ajax({
                    url: "/api/categories/",
                    async: false,
                    success: function(jsonData, httpStatus, xhr){
                        catData = JSON.parse(jsonData);
                    }
                });
            }

            var toggleSeries = function(link, add){
                var link_id = link.attr("id");
                var cat_id = link_id.replace("_link", "")
                graphedData[cat_id] = add ? timeseriesData[cat_id] : new Array();
                loadGraphData();

                for (cat_id in graphedData){
                    var link_id = "#" + cat_id + "_link";
                    var new_link = $(link_id);
                    var visible = graphedData[cat_id].length > 0;
                    new_link.html(visible ? "-" : "+");
                    if (!visible){
                        new_link.attr("class", "addSeries")
                    }
                }

                $('.addSeries').unbind('click')
                $('.killSeries').unbind('click')
                $('.addSeries').bind('click', addSeries)
                $('.killSeries').bind('click', killSeries)
                $("#tooltip").remove();
                return false;
            }

            var buildLabel = function(label, series) {
                var link = "";
                if (graphedData[label].length > 0){
                    link = "<a id='" + label + "_link' class='killSeries' href='#'>-</a>"
                }
                else {
                    link = "<a id='" + label + "_link' class='addSeries' href='#'>+</a>"
                }
                var human_name = catData[label]["human_name"];
                return human_name + "&nbsp;" + link;
            }

            var loadGraphData = function(){
                filterThreshold = parseInt($("#filter_threshold").val());
                // Empty array to hold chart data
                var chartData = new Array();
                for (cat in graphedData) {
                    // Store category name & data for chart
                    if (catCounts[cat] > filterThreshold){
                        chartData.push(
                            { label: cat, data: graphedData[cat] }
                        )
                    }
                }

                drawAggChart(chartData);
            }

            var getAggregateData = function() {
                $("#loadingMsg").show();
                getCategoryMetadata();
                timeSlice = $("#slice_selection").val();

                var handler = $.ajax({
                    url: "/api/categories/timeseries/?time_slice=" + timeSlice,
                    success: function(returnedData, httpStatus, xhr){
                        timeseriesData = JSON.parse(returnedData);

                        for (cat in timeseriesData) {
                            if (!(cat in graphedData) || graphedData[cat].length > 0){
                                graphedData[cat] = timeseriesData[cat];
                            }

                            // Sum total instances per category
                            var catTotal = 0;
                            for (var i=0, arr; arr=timeseriesData[cat][i]; i++) {
                                catTotal += arr[1];
                            }
                            catCounts[cat] = catTotal;

                            // Get human-readable category name
                            getCategoryName(cat, catTotal);
                        }
                        loadGraphData();
                        $('.addSeries').bind('click', addSeries)
                        $('.killSeries').bind('click', killSeries)
                    }
                });
            }

            var drawAggChart = function(chartData) {
                $("#loadingMsg").hide();
                $.plot(
                    $("#aggregatePlaceholder"),
                    chartData,
                    {
                        series: {
                            lines: { show: true },
                            points: { show: true }
                        },
                        xaxis: { mode: "time" },
                        yaxis: { min: 1 },
                        grid: { hoverable: true, clickable: true },
                        legend: {
                            labelFormatter: buildLabel,
                            container: "#legend",
                            noColumns: 3
                        }
                    }
                );
            }

            var getCategoryName = function(catId, catTotal) {
                var catName = catData[catId].human_name;
                writeAggKey(catId, catName, catTotal);
            }

            // Write key for aggregate chart
            var writeAggKey = function(catId, catName, catTotal) {

                // Add category name & totals to key
                if ($("#"+catId).length === 0){
                    $("#key").append(
                        '<div class="keyEntry" id="'+catId+'"></div>')
                }

                $("#"+catId).html('<div class="catTotal"><h1>'+catTotal+'</h1></div><div class="catName"><a href="/category/'+catId+'/?time_slice='+timeSlice+'">'+catName+'</a></div>')
            }

            function showTooltip(x, y, contents) {
                $('<div id="tooltip">' + contents + '</div>').css( {
                    position: 'absolute',
                    display: 'none',
                    top: y + 5,
                    left: x + 5,
                    border: '1px solid #fdd',
                    padding: '2px',
                    'background-color': '#fee',
                    opacity: 0.80
                }).appendTo("body").fadeIn(200);
            }

            var previousPoint = null;
            $("#aggregatePlaceholder").bind("plothover", function (event, pos, item) {
                $("#x").text(pos.x.toFixed(2));
                $("#y").text(pos.y.toFixed(2));

                if (item) {
                    if (previousPoint != item.dataIndex) {
                        previousPoint = item.dataIndex;

                        $("#tooltip").remove();
                        var x = item.datapoint[0].toFixed(2),
                            y = item.datapoint[1].toFixed(2);

                        var catData = "";
                        $.ajax({
                            async: false,
                            url: "/api/categories/",
                            success: function(jsonData, httpStatus, xhr){
                                catData = JSON.parse(jsonData);
                            }
                        });

                        var date = new Date(Math.floor(x));
                        var date_str = date.getFullYear() + "/" + date.getMonth() + "/" + date.getDay();
                        var time_str = date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
                        for(var cat in catData){
                            if (item.series.label == cat){
                                cat_name = catData[cat]["human_name"];
                            }
                        }
                        var tooltip_msg = "At " + date_str + " " + time_str + " " + " category " + cat_name  + " got " + y + " hits"

                        showTooltip(
                            item.pageX, item.pageY,
                            tooltip_msg
                        );
                    }
                }
                else {
                    $("#tooltip").remove();
                    previousPoint = null;
                }
            });

            $("#aggregatePlaceholder").bind("plotclick", function (event, pos, item) {
                if (item) {
                    window.open('/category/' + item.series.label + "/?time_slice=" + timeSlice)
                }
            });

            $(function () {
                // Get default timeseries data for all categories
                // & draw chart
                getAggregateData();
            });

            $("#filter_threshold").bind("keyup", loadGraphData)
            $("#slice_selection").bind("change", getAggregateData)

            setInterval(function() {
                var reload_check = $("#reload_check");
                if (reload_check.is(':checked')){
                    var reload_input = $("#reload_input");
                    reloadEvery = parseInt(reload_input.val())
                    if (reloadEvery < timeSinceReload){
                        timeSinceReload = 0;
                        getAggregateData();
                    }
                    else {
                        timeSinceReload += 1;
                        $("#last_reload").html(timeSinceReload);
                    }
                }
                else{
                    $("#last_reload").html("-");
                }
            }, 1000);

        </script>
        {% endblock %}
